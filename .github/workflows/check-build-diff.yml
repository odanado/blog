name: Check build diff

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  workflow_dispatch:

jobs:
  if-label:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'dependencies')
    steps:
      - run: echo Found dependencies label

  build-on-main:
    needs:
      - if-label
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: main
      - uses: actions/setup-node@v3
        with:
          cache: npm
          node-version-file: .node-version

      - run: npm ci
      - run: npm run build
        env:
          ORIGIN: https://blog.odan.dev

      - uses: actions/upload-artifact@v3
        with:
          name: ${{ github.sha }}-main
          path: dist

  build-on-current:
    needs:
      - if-label
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          cache: npm
          node-version-file: .node-version

      - run: npm ci
      - run: npm run build
        env:
          ORIGIN: https://blog.odan.dev

      - uses: actions/upload-artifact@v3
        with:
          name: ${{ github.sha }}-current
          path: dist

  check-build-diff:
    needs:
      - build-on-main
      - build-on-current
    outputs:
      diff-name-only: ${{ steps.diff-name-only.outputs.result }}
      diff-exit-code: ${{ steps.diff-exit-code.outputs.result }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: ${{ github.sha }}-main
          path: dist-main
      - uses: actions/download-artifact@v3
        with:
          name: ${{ github.sha }}-current
          path: dist-current
      - uses: actions/setup-node@v3
        with:
          cache: npm
          node-version-file: .node-version

      - run: npm ci

      - id: diff-name-only
        uses: actions/github-script@v6
        with:
          script: |
            const { execa } = await import("execa");
            const { stdout } = await execa("diff", ["-qr", "dist-main", "dist-current"]);
            return stdout;

      - id: diff-exit-code
        run: |
          diff -qr dist-main dist-current
          echo "result=$?" >> "$GITHUB_OUTPUT"

  add-pr-comment:
    needs:
      - check-build-diff
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - uses: mshick/add-pr-comment@v2
        with:
          message: |
            # Check build diff report
            ```
            ${{ needs.check-build-diff.outputs.diff-name-only }}
            ```

  add-label:
    needs:
      - check-build-diff
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions-ecosystem/action-add-labels@v1
        if: ${{ needs.check-build-diff.outputs.diff-exit-code == 0 }}
        with:
          labels: no build diff
